import React, { useState, useEffect, useRef } from 'react';
import { useNavigate } from 'react-router-dom';
import { 
  MapPin, 
  Phone, 
  Mail, 
  Globe, 
  Instagram, 
  ShoppingCart,
  Clock,
  Car,
  Flower,
  ArrowLeft,
  ExternalLink,
  Star,
  Navigation,
  Route,
  Calendar,
  Info,
  Heart,
  Share2,
  Map,
  ZoomIn,
  ZoomOut
} from 'lucide-react';
import { StoreService } from '../services/storeService';

// Google Maps JavaScript API„ÅÆÂûãÂÆöÁæ©
declare global {
  interface Window {
    google: any;
  }
}

// StoreÂûã„ÇíÁõ¥Êé•ÂÆöÁæ©
interface Store {
  id: string;
  store_name: string;
  owner_name: string;
  address: string;
  latitude: number;
  longitude: number;
  phone: string | null;
  email: string | null;
  website: string | null;
  instagram: string | null;
  online_shop: string | null;
  description: string | null;
  business_hours: string | null;
  business_type: string | null;
  tags: string[] | null;
  has_parking: boolean;
  photos: string[] | null;
  is_verified: boolean;
  is_active: boolean;
  created_at: string;
  updated_at: string;
  bulletin_board: string | null;
}

// StoreDetailsÂûã„ÇíÁõ¥Êé•ÂÆöÁæ©
interface StoreDetails {
  id: string;
  store_name: string;
  owner_name: string;
  address: string;
  latitude: number;
  longitude: number;
  phone: string | null;
  email: string | null;
  website: string | null;
  instagram: string | null;
  online_shop: string | null;
  description: string | null;
  business_hours: string | null;
  business_type: string | null;
  tags: string[] | null;
  has_parking: boolean;
  photos: string[] | null;
  is_verified: boolean;
  is_active: boolean;
  created_at: string;
  updated_at: string;
  bulletin_board: string | null;
  business_hours_details: any[];
  services: any[];
  recommended_flowers: any[];
  active_posts: any[];
}

export const FloristMap: React.FC = () => {
  const navigate = useNavigate();
  const [stores, setStores] = useState<Store[]>([]);
  const [selectedStore, setSelectedStore] = useState<StoreDetails | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');
  const [mapCenter, setMapCenter] = useState({ lat: 35.6762, lng: 139.6503 }); // Êù±‰∫¨‰∏≠ÂøÉ
  const [mapLoaded, setMapLoaded] = useState(false);
  const [showRoute, setShowRoute] = useState(false);
  const [userLocation, setUserLocation] = useState<{lat: number, lng: number} | null>(null);
  const [map, setMap] = useState<any>(null);
  const [markers, setMarkers] = useState<any[]>([]);
  const [directionsService, setDirectionsService] = useState<any>(null);
  const [directionsRenderer, setDirectionsRenderer] = useState<any>(null);
  const mapRef = useRef<HTMLDivElement>(null);

  // Google Maps JavaScript API„Ç≠„Éº
  const GOOGLE_MAPS_API_KEY = 'AIzaSyDcJkaHDTPcgBSfr2923T6K6YT_kiL3s4g';

  useEffect(() => {
    loadStores();
    
    // „É¶„Éº„Ç∂„Éº„ÅÆ‰ΩçÁΩÆÊÉÖÂ†±„ÇíÂèñÂæó
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          setUserLocation({
            lat: position.coords.latitude,
            lng: position.coords.longitude
          });
        },
        (error) => {
          console.log('‰ΩçÁΩÆÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó:', error);
        }
      );
    }

    // „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÈñ¢Êï∞
    return () => {
      // „Éû„Éº„Ç´„Éº„Çí„ÇØ„É™„Ç¢
      markers.forEach(marker => {
        if (marker && marker.setMap) {
          marker.setMap(null);
        }
      });
      
      // ÁµåË∑Ø„É¨„É≥„ÉÄ„É©„Éº„Çí„ÇØ„É™„Ç¢
      if (directionsRenderer) {
        directionsRenderer.setMap(null);
      }
    };
  }, []);

  // Google Maps JavaScript API„ÅÆË™≠„ÅøËæº„Åø
  useEffect(() => {
    const loadGoogleMapsAPI = () => {
      if (window.google && window.google.maps) {
        console.log('Google Maps API already loaded');
        if (stores.length > 0) {
          initializeMap();
        }
        return;
      }

      const existingScript = document.querySelector('script[src*="maps.googleapis.com"]');
      if (existingScript) {
        console.log('Google Maps API script already exists');
        return;
      }

      const script = document.createElement('script');
      script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places`;
      script.async = true;
      script.defer = true;
      script.onload = () => {
        console.log('Google Maps API loaded successfully');
        if (stores.length > 0) {
          initializeMap();
        }
      };
      script.onerror = () => {
        console.error('Failed to load Google Maps API');
      };
      document.head.appendChild(script);
    };

    loadGoogleMapsAPI();
  }, [GOOGLE_MAPS_API_KEY, stores.length]);

  // Â∫óËàó„Éá„Éº„Çø„ÅåË™≠„ÅøËæº„Åæ„Çå„ÅüÂæå„Å´Âú∞Âõ≥„ÇíÂàùÊúüÂåñ
  useEffect(() => {
    if (stores.length > 0 && window.google && window.google.maps && !map) {
      console.log('Stores loaded, initializing map...');
      initializeMap();
    }
  }, [stores.length, map]);

  // Âú∞Âõ≥„ÅÆÂàùÊúüÂåñ
  const initializeMap = () => {
    if (!mapRef.current || !window.google) return;

    try {
      console.log('Initializing Google Maps...');
      
      let center = mapCenter;
      if (stores.length > 0) {
        const centerLat = stores.reduce((sum, store) => sum + store.latitude, 0) / stores.length;
        const centerLng = stores.reduce((sum, store) => sum + store.longitude, 0) / stores.length;
        center = { lat: centerLat, lng: centerLng };
      }
      
      const mapInstance = new window.google.maps.Map(mapRef.current, {
        center: center,
        zoom: 10,
        mapTypeId: window.google.maps.MapTypeId.ROADMAP,
        mapTypeControl: true,
        streetViewControl: true,
        fullscreenControl: true,
        zoomControl: true,
        styles: [
          {
            featureType: 'poi.business',
            elementType: 'labels',
            stylers: [{ visibility: 'off' }]
          }
        ]
      });

      console.log('Map instance created successfully');
      
      window.google.maps.event.addListenerOnce(mapInstance, 'idle', () => {
        console.log('Map is idle - fully loaded');
        setMapLoaded(true);
      });
      
      setMap(mapInstance);
      setDirectionsService(new window.google.maps.DirectionsService());
      setDirectionsRenderer(new window.google.maps.DirectionsRenderer({
        suppressMarkers: true
      }));
      
      console.log('Map initialization completed');
    } catch (error) {
      console.error('Error initializing map:', error);
    }
  };

  // „Éû„Éº„Ç´„Éº„Å®InfoWindow„ÅÆÊõ¥Êñ∞
  useEffect(() => {
    if (!map || !window.google || !window.google.maps) {
      console.log('Map or Google Maps API not ready for markers');
      return;
    }

    try {
      console.log('Updating markers and info windows...');
      
      // Êó¢Â≠ò„ÅÆ„Éû„Éº„Ç´„Éº„Çí„ÇØ„É™„Ç¢
      markers.forEach(marker => {
        if (marker && marker.setMap) {
          marker.setMap(null);
        }
      });
      
      const newMarkers: any[] = [];
      const infoWindows: any[] = [];

      stores.forEach((store, index) => {
        try {
          // „Éû„Éº„Ç´„Éº„Çí‰ΩúÊàê
          const marker = new window.google.maps.Marker({
            position: { lat: store.latitude, lng: store.longitude },
            map: map,
            title: store.store_name,
            label: {
              text: (index + 1).toString(),
              color: 'white',
              fontSize: '12px',
              fontWeight: 'bold'
            },
            icon: {
              url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                <svg width="30" height="30" viewBox="0 0 30 30" xmlns="http://www.w3.org/2000/svg">
                  <circle cx="15" cy="15" r="12" fill="#3b82f6" stroke="white" stroke-width="2"/>
                  <text x="15" y="18" text-anchor="middle" fill="white" font-size="10" font-weight="bold">${index + 1}</text>
                </svg>
              `),
              scaledSize: new window.google.maps.Size(30, 30),
              anchor: new window.google.maps.Point(15, 15)
            }
          });

          // InfoWindow„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Çí‰ΩúÊàê
          const infoWindowContent = createInfoWindowContent(store);

          // InfoWindow„Çí‰ΩúÊàê
          const infoWindow = new window.google.maps.InfoWindow({
            content: infoWindowContent,
            maxWidth: 300
          });

          // „Éû„Éº„Ç´„Éº„ÇØ„É™„ÉÉ„ÇØÊôÇ„Å´InfoWindow„ÇíÈñã„Åè
          marker.addListener('click', () => {
            // ‰ªñ„ÅÆInfoWindow„ÇíÈñâ„Åò„Çã
            infoWindows.forEach(iw => iw.close());
            
            // „Åì„ÅÆInfoWindow„ÇíÈñã„Åè
            infoWindow.open(map, marker);
            
            // Â∫óËàó„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„Çã
            handleStoreClick(store);
          });

          newMarkers.push(marker);
          infoWindows.push(infoWindow);
        } catch (error) {
          console.error('Error creating marker for store:', store.store_name, error);
        }
      });

      setMarkers(newMarkers);
      console.log('Markers and info windows updated successfully');
    } catch (error) {
      console.error('Error updating markers:', error);
    }
  }, [map, stores, selectedStore]);

  // InfoWindow„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Çí‰ΩúÊàê
  const createInfoWindowContent = (store: Store) => {
    return `
      <div style="padding: 10px; max-width: 280px; font-family: Arial, sans-serif;">
        <div style="display: flex; align-items: center; margin-bottom: 10px;">
          <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px;">
            <span style="color: white; font-size: 18px;">üå∏</span>
          </div>
          <div>
            <h3 style="margin: 0; color: #1f2937; font-size: 16px; font-weight: bold;">${store.store_name}</h3>
            <p style="margin: 2px 0 0 0; color: #6b7280; font-size: 12px;">${store.address}</p>
          </div>
        </div>
        
        <div style="border-top: 1px solid #e5e7eb; padding-top: 8px;">
          ${store.phone ? `<p style="margin: 4px 0; color: #374151; font-size: 12px;">üìû ${store.phone}</p>` : ''}
          ${store.business_hours ? `<p style="margin: 4px 0; color: #374151; font-size: 12px;">üïí ${store.business_hours}</p>` : ''}
          ${store.has_parking ? `<p style="margin: 4px 0; color: #374151; font-size: 12px;">üöó ÈßêËªäÂ†¥„ÅÇ„Çä</p>` : ''}
        </div>
        
        <div style="margin-top: 8px;">
          <button onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${store.latitude},${store.longitude}', '_blank')" 
                  style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; margin-right: 5px;">
            ÁµåË∑ØÊ°àÂÜÖ
          </button>
          <button onclick="window.open('tel:${store.phone || ''}', '_self')" 
                  style="background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">
            ÈõªË©±
          </button>
        </div>
      </div>
    `;
  };

  const loadStores = async () => {
    try {
      setLoading(true);
      
      // Supabase„Åã„ÇâÂÆüÈöõ„ÅÆÂ∫óËàó„Éá„Éº„Çø„ÇíÂèñÂæó
      const storeData = await StoreService.getAllStores();
      
      // Â∫ßÊ®ô„Åå„ÅÇ„ÇãÂ∫óËàó„ÅÆ„Åø„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
      const storesWithCoordinates = storeData.filter(store => 
        store.latitude && store.longitude && store.is_active
      );

      console.log('Loaded stores from Supabase:', storesWithCoordinates);
      setStores(storesWithCoordinates);
      
    } catch (err: any) {
      console.error('Â∫óËàóË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', err);
      
      // „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„ÅüÂ†¥Âêà„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂá¶ÁêÜ
      if (err.message?.includes('fetch') || err.message?.includes('network')) {
        setError('„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº: Supabase„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì');
      } else {
        setError('Â∫óËàóÊÉÖÂ†±„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
      }
    } finally {
      setLoading(false);
    }
  };

  // ÁµåË∑ØË°®Á§∫„ÅÆÂàá„ÇäÊõø„Åà
  const toggleRoute = () => {
    if (!userLocation || !selectedStore || !directionsService || !directionsRenderer || !map) {
      alert('‰ΩçÁΩÆÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆ‰ΩçÁΩÆÊÉÖÂ†±Ë®±ÂèØ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
      return;
    }

    if (showRoute) {
      // ÁµåË∑Ø„ÇíÈùûË°®Á§∫
      directionsRenderer.setMap(null);
      setShowRoute(false);
    } else {
      // ÁµåË∑Ø„ÇíË°®Á§∫
      const request = {
        origin: userLocation,
        destination: { lat: selectedStore.latitude, lng: selectedStore.longitude },
        travelMode: window.google.maps.TravelMode.DRIVING
      };

      directionsService.route(request, (result: any, status: any) => {
        if (status === 'OK') {
          directionsRenderer.setDirections(result);
          directionsRenderer.setMap(map);
          setShowRoute(true);
        } else {
          alert('ÁµåË∑Ø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
        }
      });
    }
  };

  const handleStoreClick = async (store: Store) => {
    try {
      const storeDetails = await StoreService.getStoreDetails(store.id);
      setSelectedStore(storeDetails);
      setShowRoute(false); // Êñ∞„Åó„ÅÑÂ∫óËàóÈÅ∏ÊäûÊôÇ„Å´ÁµåË∑Ø„Çí„É™„Çª„ÉÉ„Éà
    } catch (err) {
      console.error('Â∫óËàóË©≥Á¥∞„ÅÆÂèñÂæó„Å´Â§±Êïó:', err);
    }
  };



  // Google Maps„ÅßÁµåË∑ØÊ°àÂÜÖ„ÇíÈñã„Åè
  const openDirections = () => {
    if (!selectedStore || !userLocation) return;
    
    const origin = `${userLocation.lat},${userLocation.lng}`;
    const destination = `${selectedStore.latitude},${selectedStore.longitude}`;
    const url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&travelmode=driving`;
    window.open(url, '_blank');
  };

  // Â∫óËàóÊÉÖÂ†±„ÇíÂÖ±Êúâ
  const shareStore = async () => {
    if (!selectedStore) return;
    
    const shareData = {
      title: `${selectedStore.store_name} - Ëä±Â±ã`,
      text: `${selectedStore.store_name}„ÅÆË©≥Á¥∞ÊÉÖÂ†±`,
      url: window.location.href
    };

    if (navigator.share) {
      try {
        await navigator.share(shareData);
      } catch (err) {
        console.log('ÂÖ±Êúâ„Å´Â§±Êïó:', err);
      }
    } else {
      // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: URL„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº
      navigator.clipboard.writeText(window.location.href);
      alert('URL„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');
    }
  };

  // 2ÁÇπÈñì„ÅÆË∑ùÈõ¢„ÇíË®àÁÆóÔºà„Éè„Éê„Éº„Çµ„Ç§„É≥ÂÖ¨ÂºèÔºâ
  const calculateDistance = (lat1: number, lon1: number, lat2: number, lon2: number): number => {
    const R = 6371; // Âú∞ÁêÉ„ÅÆÂçäÂæÑÔºàkmÔºâ
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = 
      Math.sin(dLat/2) * Math.sin(dLat/2) +
      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
      Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  };

  // Âú∞Âõ≥„ÅÆ„Ç∫„Éº„É†Âà∂Âæ°
  const zoomIn = () => {
    if (map) {
      map.setZoom(map.getZoom() + 1);
    }
  };

  const zoomOut = () => {
    if (map) {
      map.setZoom(map.getZoom() - 1);
    }
  };

  // Âú∞Âõ≥„ÇíÁèæÂú®Âú∞„Å´ÁßªÂãï
  const centerOnUserLocation = () => {
    if (map && userLocation) {
      map.setCenter(userLocation);
      map.setZoom(15);
    }
  };

  const handleStoreSelect = (store: Store) => {
    handleStoreClick(store);
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-pink-50 to-purple-50 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-32 w-32 border-b-2 border-pink-500 mx-auto mb-4"></div>
          <p className="text-gray-600">Âú∞Âõ≥„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-pink-50 to-purple-50 flex items-center justify-center">
        <div className="text-center">
          <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg max-w-md">
            <p className="font-bold">„Ç®„É©„Éº</p>
            <p>{error}</p>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-pink-50 to-purple-50">
      {/* „Éò„ÉÉ„ÉÄ„Éº */}
      <div className="bg-white shadow-sm border-b border-gray-200">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center h-16">
            <div className="flex items-center space-x-3">
              <button
                onClick={() => navigate('/menu')}
                className="p-2 text-gray-400 hover:text-gray-600 transition-colors duration-200"
              >
                <ArrowLeft className="h-6 w-6" />
              </button>
              <div className="h-10 w-10 bg-gradient-to-r from-pink-400 to-purple-500 rounded-lg flex items-center justify-center">
                <MapPin className="h-6 w-6 text-white" />
              </div>
              <div>
                <h1 className="text-xl font-bold text-gray-900">ÂÖ®ÂõΩ„Éï„É≠„Éº„É™„Çπ„Éà„Éû„ÉÉ„Éó</h1>
                <p className="text-sm text-gray-500">Ëä±Â±ã„ÅÆ‰ΩçÁΩÆÊÉÖÂ†±„ÇíÁ¢∫Ë™ç</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          {/* Âú∞Âõ≥„Ç®„É™„Ç¢ */}
          <div className="lg:col-span-2">
            <div className="bg-white rounded-2xl shadow-lg overflow-hidden">
              <div className="p-6 border-b border-gray-200">
                <h2 className="text-lg font-semibold text-gray-900 flex items-center">
                  <MapPin className="h-5 w-5 mr-2 text-pink-500" />
                  ÂÖ®ÂõΩ„ÅÆËä±Â±ã„Éû„ÉÉ„Éó
                </h2>
                <p className="text-sm text-gray-600 mt-1">
                  Âú∞Âõ≥‰∏ä„ÅÆ„Éû„Éº„Ç´„Éº„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Â∫óËàóË©≥Á¥∞„ÇíÁ¢∫Ë™ç
                </p>
              </div>
              
              <div className="relative">
                {GOOGLE_MAPS_API_KEY ? (
                  <div className="relative">
                    {/* ÂãïÁöÑ„Å™Google Maps */}
                    <div 
                      ref={mapRef} 
                      className="w-full h-96 rounded-lg overflow-hidden bg-gray-100"
                      style={{ minHeight: '384px' }}
                    />
                    
                    {/* „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†± */}
                    <div className="absolute bottom-4 left-4 bg-black bg-opacity-75 text-white text-xs p-2 rounded">
                      <div>Map Loaded: {mapLoaded ? 'Yes' : 'No'}</div>
                      <div>Map Instance: {map ? 'Yes' : 'No'}</div>
                      <div>Stores: {stores.length}</div>
                      <div>Markers: {markers.length}</div>
                    </div>
                    
                    {/* Âú∞Âõ≥„Ç≥„É≥„Éà„É≠„Éº„É´ */}
                    <div className="absolute top-4 right-4 flex flex-col space-y-2">
                      <button
                        onClick={zoomIn}
                        className="w-10 h-10 bg-white rounded-lg shadow-lg flex items-center justify-center hover:bg-gray-50 transition-colors duration-200"
                        title="Êã°Â§ß"
                      >
                        <ZoomIn className="h-5 w-5 text-gray-700" />
                      </button>
                      <button
                        onClick={zoomOut}
                        className="w-10 h-10 bg-white rounded-lg shadow-lg flex items-center justify-center hover:bg-gray-50 transition-colors duration-200"
                        title="Á∏ÆÂ∞è"
                      >
                        <ZoomOut className="h-5 w-5 text-gray-700" />
                      </button>
                      {userLocation && (
                        <button
                          onClick={centerOnUserLocation}
                          className="w-10 h-10 bg-blue-600 rounded-lg shadow-lg flex items-center justify-center hover:bg-blue-700 transition-colors duration-200"
                          title="ÁèæÂú®Âú∞„Å´ÁßªÂãï"
                        >
                          <Navigation className="h-5 w-5 text-white" />
                        </button>
                      )}
                    </div>
                    
                    {/* Ë™≠„ÅøËæº„Åø‰∏≠Ë°®Á§∫ */}
                    {!mapLoaded && (
                      <div className="absolute inset-0 bg-gray-200 flex items-center justify-center">
                        <div className="text-center">
                          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-2"></div>
                          <p className="text-gray-600">Âú∞Âõ≥„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>
                          <p className="text-xs text-gray-500 mt-2">
                            {stores.length > 0 ? `${stores.length}‰ª∂„ÅÆÂ∫óËàó„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü` : 'Â∫óËàó„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...'}
                          </p>
                        </div>
                      </div>
                    )}
                    
                    {/* Âú∞Âõ≥Ë™≠„ÅøËæº„ÅøÂ§±ÊïóÊôÇ„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ */}
                    {!mapLoaded && stores.length > 0 && (
                      <div className="absolute inset-0 bg-gray-100 flex items-center justify-center">
                        <div className="text-center">
                          <MapPin className="h-16 w-16 text-gray-400 mx-auto mb-4" />
                          <p className="text-gray-600">Âú∞Âõ≥„ÅÆË™≠„ÅøËæº„Åø„Å´ÊôÇÈñì„Åå„Åã„Åã„Å£„Å¶„ÅÑ„Åæ„Åô</p>
                          <button
                            onClick={() => window.location.reload()}
                            className="mt-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                          >
                            „Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø
                          </button>
                        </div>
                      </div>
                    )}
                  </div>
                ) : (
                  <div className="w-full h-96 bg-gray-200 flex items-center justify-center">
                    <div className="text-center">
                      <MapPin className="h-16 w-16 text-gray-400 mx-auto mb-4" />
                      <p className="text-gray-600">Google Maps API„Ç≠„Éº„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>
                      <p className="text-sm text-gray-500 mt-2">
                        API„Ç≠„Éº„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                      </p>
                    </div>
                  </div>
                )}
                
                {/* Â∫óËàó„É™„Çπ„Éà„Ç™„Éº„Éê„Éº„É¨„Ç§ */}
                <div className="absolute top-4 left-4 bg-white rounded-lg shadow-lg p-4 max-w-xs z-10">
                  <h3 className="font-semibold text-gray-900 mb-3">Â∫óËàó‰∏ÄË¶ß</h3>
                  <div className="space-y-2 max-h-64 overflow-y-auto">
                    {stores.map((store, index) => (
                      <button
                        key={store.id}
                        onClick={() => handleStoreSelect(store)}
                        className={`w-full text-left p-2 rounded-lg transition-colors duration-200 ${
                          selectedStore?.id === store.id
                            ? 'bg-pink-100 text-pink-700'
                            : 'hover:bg-gray-100'
                        }`}
                      >
                        <div className="flex items-center space-x-2">
                          <div className={`w-3 h-3 rounded-full ${
                            selectedStore?.id === store.id ? 'bg-red-500' : 'bg-blue-500'
                          }`}></div>
                          <span className="text-sm font-medium">{store.store_name}</span>
                        </div>
                        <p className="text-xs text-gray-500 mt-1">{store.address}</p>
                      </button>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Â∫óËàóË©≥Á¥∞„Çµ„Ç§„Éâ„Éê„Éº */}
          <div className="lg:col-span-1">
            {selectedStore ? (
              <div className="bg-white rounded-2xl shadow-lg p-6 sticky top-8">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-semibold text-gray-900">Â∫óËàóË©≥Á¥∞</h3>
                  <div className="flex items-center space-x-2">
                    <button
                      onClick={shareStore}
                      className="p-2 text-gray-400 hover:text-gray-600 transition-colors duration-200"
                      title="ÂÖ±Êúâ"
                    >
                      <Share2 className="h-4 w-4" />
                    </button>
                    <button
                      onClick={() => setSelectedStore(null)}
                      className="text-gray-400 hover:text-gray-600"
                    >
                      √ó
                    </button>
                  </div>
                </div>

                <div className="space-y-6">
                  {/* Â∫óËàóÂêç */}
                  <div>
                    <h4 className="text-xl font-bold text-gray-900 mb-2">
                      {selectedStore.store_name}
                    </h4>
                    <p className="text-gray-600">{selectedStore.address}</p>
                    
                    {/* „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ */}
                    <div className="flex items-center space-x-2 mt-3">
                      <button
                        onClick={toggleRoute}
                        className={`flex items-center space-x-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors duration-200 ${
                          showRoute 
                            ? 'bg-blue-100 text-blue-700 border border-blue-300' 
                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                        }`}
                      >
                        <Route className="h-4 w-4" />
                        <span>{showRoute ? 'ÁµåË∑ØÈùûË°®Á§∫' : 'ÁµåË∑ØË°®Á§∫'}</span>
                      </button>
                      
                      {userLocation && (
                        <button
                          onClick={openDirections}
                          className="flex items-center space-x-1 px-3 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition-colors duration-200"
                        >
                          <Map className="h-4 w-4" />
                          <span>ÁµåË∑ØÊ°àÂÜÖ</span>
                        </button>
                      )}
                    </div>
                    
                    {/* Ë∑ùÈõ¢Ë°®Á§∫ */}
                    {userLocation && (
                      <div className="mt-2 p-2 bg-blue-50 rounded-lg">
                        <p className="text-sm text-blue-700">
                          <Navigation className="h-4 w-4 inline mr-1" />
                          ÁèæÂú®Âú∞„Åã„Çâ„ÅÆË∑ùÈõ¢: {calculateDistance(userLocation.lat, userLocation.lng, selectedStore.latitude, selectedStore.longitude).toFixed(1)}km
                        </p>
                      </div>
                    )}
                  </div>

                  {/* ÈÄ£Áµ°ÂÖà */}
                  <div className="space-y-3">
                    <h5 className="font-semibold text-gray-900 flex items-center">
                      <Phone className="h-4 w-4 mr-2 text-green-500" />
                      ÈÄ£Áµ°ÂÖà
                    </h5>
                    <div className="space-y-2">
                      {selectedStore.phone && (
                        <div className="flex items-center space-x-2">
                          <Phone className="h-4 w-4 text-gray-400" />
                          <span className="text-sm">{selectedStore.phone}</span>
                        </div>
                      )}
                      {selectedStore.email && (
                        <div className="flex items-center space-x-2">
                          <Mail className="h-4 w-4 text-gray-400" />
                          <span className="text-sm">{selectedStore.email}</span>
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Âñ∂Ê•≠ÊôÇÈñì */}
                  {selectedStore.business_hours && (
                    <div>
                      <h5 className="font-semibold text-gray-900 flex items-center mb-2">
                        <Clock className="h-4 w-4 mr-2 text-blue-500" />
                        Âñ∂Ê•≠ÊôÇÈñì
                      </h5>
                      <p className="text-sm text-gray-600">{selectedStore.business_hours}</p>
                    </div>
                  )}

                  {/* „Çø„Ç∞ */}
                  {selectedStore.tags && selectedStore.tags.length > 0 && (
                    <div>
                      <h5 className="font-semibold text-gray-900 flex items-center mb-2">
                        <Info className="h-4 w-4 mr-2 text-purple-500" />
                        ÁâπÂæ¥
                      </h5>
                      <div className="flex flex-wrap gap-2">
                        {selectedStore.tags.map((tag, index) => (
                          <span
                            key={index}
                            className="px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium"
                          >
                            {tag}
                          </span>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* Â∫óËàó„Çø„Ç§„Éó */}
                  {selectedStore.business_type && (
                    <div>
                      <h5 className="font-semibold text-gray-900 flex items-center mb-2">
                        <Flower className="h-4 w-4 mr-2 text-pink-500" />
                        Â∫óËàó„Çø„Ç§„Éó
                      </h5>
                      <p className="text-sm text-gray-600">{selectedStore.business_type}</p>
                    </div>
                  )}

                  {/* ÂÆö‰ºëÊó• */}
                  {selectedStore.business_hours && selectedStore.business_hours.includes('ÂÆö‰ºë') && (
                    <div>
                      <h5 className="font-semibold text-gray-900 flex items-center mb-2">
                        <Calendar className="h-4 w-4 mr-2 text-red-500" />
                        ÂÆö‰ºëÊó•
                      </h5>
                      <p className="text-sm text-gray-600">
                        {selectedStore.business_hours.includes('ÂÆö‰ºë') 
                          ? selectedStore.business_hours.split('ÂÆö‰ºë')[1]?.trim() || 'Âñ∂Ê•≠ÊôÇÈñì„Çí„ÅîÁ¢∫Ë™ç„Åè„Å†„Åï„ÅÑ'
                          : 'Âñ∂Ê•≠ÊôÇÈñì„Çí„ÅîÁ¢∫Ë™ç„Åè„Å†„Åï„ÅÑ'
                        }
                      </p>
                    </div>
                  )}

                  {/* ÈßêËªäÂ†¥ */}
                  <div>
                    <h5 className="font-semibold text-gray-900 flex items-center mb-2">
                      <Car className="h-4 w-4 mr-2 text-orange-500" />
                      ÈßêËªäÂ†¥
                    </h5>
                    <p className="text-sm text-gray-600">
                      {selectedStore.has_parking ? '„ÅÇ„Çä' : '„Å™„Åó'}
                    </p>
                  </div>

                  {/* „É™„É≥„ÇØ */}
                  <div className="space-y-3">
                    <h5 className="font-semibold text-gray-900 flex items-center">
                      <Globe className="h-4 w-4 mr-2 text-purple-500" />
                      „É™„É≥„ÇØ
                    </h5>
                    <div className="space-y-2">
                      {selectedStore.website && (
                        <a
                          href={selectedStore.website}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="flex items-center space-x-2 text-sm text-blue-600 hover:text-blue-800 transition-colors duration-200"
                        >
                          <ExternalLink className="h-4 w-4" />
                          <span>ÂÖ¨Âºè„Çµ„Ç§„Éà</span>
                        </a>
                      )}
                      {selectedStore.instagram && (
                        <a
                          href={selectedStore.instagram}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="flex items-center space-x-2 text-sm text-pink-600 hover:text-pink-800 transition-colors duration-200"
                        >
                          <Instagram className="h-4 w-4" />
                          <span>Instagram</span>
                        </a>
                      )}
                      {selectedStore.online_shop && (
                        <a
                          href={selectedStore.online_shop}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="flex items-center space-x-2 text-sm text-green-600 hover:text-green-800 transition-colors duration-200"
                        >
                          <ShoppingCart className="h-4 w-4" />
                          <span>„Ç™„É≥„É©„Ç§„É≥„Ç∑„Éß„ÉÉ„Éó</span>
                        </a>
                      )}
                    </div>
                  </div>

                  {/* „Çµ„Éº„Éì„Çπ */}
                  {selectedStore.services && selectedStore.services.length > 0 && (
                    <div>
                      <h5 className="font-semibold text-gray-900 flex items-center mb-3">
                        <Star className="h-4 w-4 mr-2 text-yellow-500" />
                        Êèê‰æõ„Çµ„Éº„Éì„Çπ
                      </h5>
                      <div className="flex flex-wrap gap-2">
                        {selectedStore.services.map((service, index) => (
                          <span
                            key={index}
                            className="px-3 py-1 bg-pink-100 text-pink-700 rounded-full text-xs font-medium"
                          >
                            {service.service_name}
                          </span>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* „Åä„Åô„Åô„ÇÅ„ÅÆËä± */}
                  {selectedStore.recommended_flowers && selectedStore.recommended_flowers.length > 0 && (
                    <div>
                      <h5 className="font-semibold text-gray-900 flex items-center mb-3">
                        <Flower className="h-4 w-4 mr-2 text-pink-500" />
                        „Åä„Åô„Åô„ÇÅ„ÅÆËä±
                      </h5>
                      <div className="space-y-2">
                        {selectedStore.recommended_flowers.slice(0, 3).map((flower, index) => (
                          <div key={index} className="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                            <div>
                              <p className="text-sm font-medium">{flower.flower_name}</p>
                              <p className="text-xs text-gray-500">{flower.description}</p>
                            </div>
                            <span className="text-sm font-semibold text-pink-600">
                              ¬•{flower.price}
                            </span>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* Êé≤Á§∫Êùø */}
                  {selectedStore.active_posts && selectedStore.active_posts.length > 0 && (
                    <div>
                      <h5 className="font-semibold text-gray-900 mb-3">Êé≤Á§∫Êùø</h5>
                      <div className="space-y-2">
                        {selectedStore.active_posts.slice(0, 2).map((post: any, index: number) => (
                          <div key={index} className="p-3 bg-gray-50 rounded-lg">
                            <div className="flex items-center justify-between mb-1">
                              <span className="text-xs font-medium text-blue-600 bg-blue-100 px-2 py-1 rounded">
                                {post.post_type}
                              </span>
                              <span className="text-xs text-gray-500">
                                {new Date(post.created_at).toLocaleDateString()}
                              </span>
                            </div>
                            <p className="text-sm font-medium text-gray-900">{post.title}</p>
                            <p className="text-xs text-gray-600 mt-1 line-clamp-2">
                              {post.content}
                            </p>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* Ë™¨Êòé */}
                  {selectedStore.description && (
                    <div>
                      <h5 className="font-semibold text-gray-900 mb-2">Â∫óËàóË™¨Êòé</h5>
                      <p className="text-sm text-gray-600">{selectedStore.description}</p>
                    </div>
                  )}
                </div>
              </div>
            ) : (
              <div className="bg-white rounded-2xl shadow-lg p-6 text-center">
                <MapPin className="h-16 w-16 text-gray-300 mx-auto mb-4" />
                <h3 className="text-lg font-semibold text-gray-900 mb-2">Â∫óËàó„ÇíÈÅ∏Êäû</h3>
                <p className="text-gray-600">
                  Âú∞Âõ≥‰∏ä„ÅÆ„Éû„Éº„Ç´„Éº„Åæ„Åü„ÅØÂè≥ÂÅ¥„ÅÆÂ∫óËàó„É™„Çπ„Éà„Åã„ÇâÂ∫óËàó„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                </p>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};
