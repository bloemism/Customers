# Stripe Connect 決済テストガイド

## ✅ アカウント状態

アカウントが有効になりました！以下の状態を確認してください：

- **決済有効**: `true`
- **詳細提出**: `true`
- **カード決済**: `active`
- **必要なアクション**: なし（すべて完了）

## 🧪 決済テスト手順

### 1. 決済ページにアクセス

```
http://localhost:5173/stripe-connect-payment
```

### 2. 決済情報を入力

- **決済金額**: 任意の金額（例: 100000円 = 1000円）
- **連結アカウントID**: `acct_1SmtPlHk8MTQ5wk4`（既に入力済み）
- **プラットフォーム手数料**: 自動計算（デフォルト3%）

### 3. 決済を開始

「Stripe Connectで決済する」ボタンをクリック

### 4. Stripe Checkoutページでテストカードを使用

#### テストカード情報（本番環境のStripeキーを使用している場合）

**注意**: 本番環境のStripeキー（`sk_live_...`）を使用している場合、実際のカード情報が必要です。

テストモードの場合は以下のカードを使用：

- **カード番号**: `4242 4242 4242 4242`
- **有効期限**: 任意の未来の日付（例: `12/25`）
- **CVC**: 任意の3桁（例: `123`）
- **郵便番号**: 任意（例: `12345`）

### 5. 決済完了後の確認

決済が成功すると：
- Stripe Checkoutページから自動的にリダイレクトされます
- 決済完了ページが表示されます
- 連結アカウント（`acct_1SmtPlHk8MTQ5wk4`）に決済が記録されます
- プラットフォーム手数料（3%）が運営側のアカウントに記録されます

## 🔍 トラブルシューティング

### エラー: "連結アカウントで決済が有効になっていません"

**原因**: アカウントの状態がまだ更新されていない可能性があります。

**解決方法**:
1. `http://localhost:5173/create-account-link` にアクセス
2. 「状態を確認」ボタンをクリック
3. すべての要件が満たされているか確認
4. 数分待ってから再度試す

### エラー: "Can only apply an application_fee_amount..."

**原因**: `stripeAccount`パラメータが正しく送信されていない可能性があります。

**解決方法**:
1. ブラウザの開発者ツールでネットワークタブを確認
2. `/api/create-connect-payment-intent` のリクエストを確認
3. `connected_account_id` が正しく送信されているか確認

### エラー: CORSエラー

**原因**: ローカルAPIサーバーが起動していない可能性があります。

**解決方法**:
```bash
# ローカルAPIサーバーを起動
node server-local.js
```

## 📊 決済フローの確認

### 正常な決済フロー

1. **顧客が決済を開始**
   - 決済金額: 100,000円（1,000円）
   - プラットフォーム手数料: 3,000円（30円）

2. **Stripe Checkoutページ**
   - 顧客がカード情報を入力
   - 決済を完了

3. **決済処理**
   - 連結アカウント（`acct_1SmtPlHk8MTQ5wk4`）に決済が記録
   - Stripe決済手数料が自動的に差し引かれる
   - プラットフォーム手数料（3%）が運営側に記録

4. **入金**
   - 残りの金額が連結アカウントの銀行口座に振り込まれる
   - プラットフォーム手数料が運営側のアカウントに積み上がる

## ✅ 成功の確認

決済が成功した場合、以下を確認してください：

1. **Stripe Dashboard**
   - Connect > Accounts > `acct_1SmtPlHk8MTQ5wk4`
   - 決済が記録されているか確認

2. **運営側のStripe Dashboard**
   - プラットフォーム手数料が記録されているか確認

3. **決済完了ページ**
   - 正常にリダイレクトされているか確認

## 🎉 次のステップ

決済が正常に動作することを確認したら：

1. **メインアプリケーションに統合**
   - `PaymentPage.tsx` に統合
   - QRコードスキャンからの決済フローに統合

2. **エラーハンドリングの強化**
   - より詳細なエラーメッセージ
   - リトライ機能

3. **ログとモニタリング**
   - 決済ログの記録
   - エラー監視

